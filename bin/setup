#!/usr/bin/env ruby
require "fileutils"

APP_ROOT = File.expand_path("..", __dir__)
APP_NAME = "re-phrase"

def system!(*args)
  system(*args, exception: true)
end

def load_dotenv_file(path)
  return unless File.exist?(path)

  File.foreach(path) do |line|
    entry = line.strip
    next if entry.empty? || entry.start_with?("#")
    next unless entry.include?("=")

    key, value = entry.split("=", 2)
    key = key.strip
    value = value.strip
    value = value[1..-2] if (value.start_with?('"') && value.end_with?('"')) || (value.start_with?("'") && value.end_with?("'"))
    next if key.empty?

    ENV[key] ||= value
  end
end

FileUtils.chdir APP_ROOT do
  # コンテナ内で sudo なし運用を想定し、.env から環境変数を読み込む
  load_dotenv_file(".env")

  puts "== Installing dependencies =="
  system! "gem install bundler --conservative"
  system("bundle check") || system!("bundle install")

  # puts "\n== Copying sample files =="
  # unless File.exist?("config/database.yml")
  #   FileUtils.cp "config/database.yml.sample", "config/database.yml"
  # end

  # 外部 DB 前提のため、DATABASE_URL が未設定なら先に停止する
  if ENV["DATABASE_URL"].to_s.empty?
    abort "\nDATABASE_URL が未設定です。.env に接続情報を設定してから bin/setup を再実行してください。"
  end

  puts "\n== Preparing database =="
  system! "bin/rails db:prepare"

  puts "\n== Removing old logs and tempfiles =="
  system! "bin/rails log:clear tmp:clear"

  puts "\n== Restarting application server =="
  system! "bin/rails restart"

  # puts "\n== Configuring puma-dev =="
  # system "ln -nfs #{APP_ROOT} ~/.puma-dev/#{APP_NAME}"
  # system "curl -Is https://#{APP_NAME}.test/up | head -n 1"
end
