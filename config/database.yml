default: &default
  adapter: postgresql
  encoding: unicode
  pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %>
  # 共通フォールバック設定
  host: <%= ENV.fetch("DB_HOST", "/var/run/postgresql") %>
  port: <%= ENV.fetch("DB_PORT", 5432) %>
  username: <%= ENV.fetch("DB_USERNAME", "vscode") %>
  password: <%= ENV.fetch("DB_PASSWORD", "postgres") %>

development:
  <<: *default
  <% # DATABASE_URL の安全な読み込みロジック（development限定） %>
  <% raw_url = ENV["DATABASE_URL"].to_s.strip %>
  <% safe_url = nil %>
  <% if raw_url.present? %>
    <% begin %>
      <% uri = URI.parse(raw_url) %>
      <% if %w[postgres postgresql].include?(uri.scheme) && uri.host.present? %>
        <% safe_url = raw_url %>
      <% else %>
        <% STDERR.puts "[database.yml] DATABASE_URLの形式が不正なため無視します。フォールバック設定を利用します。" %>
      <% end %>
    <% rescue URI::InvalidURIError => e %>
      <% STDERR.puts "[database.yml] DATABASE_URLのURIパースに失敗したため無視します: #{e.message}" %>
    <% end %>
  <% end %>
  url: <%= safe_url %>
  database: <%= ENV.fetch("DB_NAME_DEVELOPMENT", "re_phrase_development") %>

test:
  <<: *default
  database: <%= ENV.fetch("DB_NAME_TEST", "re_phrase_test") %>

production:
  <<: *default
  database: <%= ENV.fetch("DB_NAME_PRODUCTION", "re_phrase_production") %>
  username: <%= ENV.fetch("DB_USERNAME", "re_phrase") %>
  password: <%= ENV["RE_PHRASE_DATABASE_PASSWORD"] || ENV["DB_PASSWORD"] %>
